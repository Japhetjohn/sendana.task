<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="images/logo.png">
    <title>Sendana - Borderless Banking</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <link rel="stylesheet" href="styles/login.css">
    <script src="https://unpkg.com/@privy-io/js-sdk-core@1.88.4/dist/index.iife.js"></script>
</head>

<body>

    <section class="main-div">
        <div class="containerr max-lg:h-full grid lg:grid-cols-2 lg:items-center max-lg:py-5 max-lg:min-h-screen">
            <div class="max-lg:flex max-lg:flex-col max-lg:justify-between">
                <div class="logo flex">
                    <a href="#" class="inline-flex items-center gap-x-2.5">
                        <img src="images/logo.png" alt="logo">
                        <span class="text-white lg:text-col-4 font-semibold text-xl leading-6">Sendana</span>
                    </a>
                </div>
                <div class="login-menu">
                    <div>
                        <h1
                            class="font-semibold text-2xl lg:text-4xl leading-full tracking-small text-col-6 mb-4 lg:mb-7">
                            Welcome</h1>
                        <p class="font-normal text-sm lg:text-base leading-[160%] tracking-small text-col-7">Today is a
                            new day.
                            It's your
                            day.
                            You shape it.
                            Sign in to start managing your transactions.</p>
                    </div>
                    <div>
                        <form action="#" class="grid gap-y-4 lg:gap-y-6">
                            <div class="flex flex-col gap-y-2">
                                <label for="email" class="form-label">Email</label>
                                <input type="text" id="email" name="email" class="form-input"
                                    placeholder="Example@email.com">
                            </div>
                            <div class="flex flex-col gap-y-2">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" id="password" name="password" class="form-input"
                                    placeholder="At least 8 characters">
                            </div>
                            <div class="text-right">
                                <a class="font-normal text-sm leading-full tracking-small text-col-11" href="#">Forgot Password?</a>
                            </div>
                            <div>
                                <button type="submit" class="form-btn">Sign in</button>
                            </div>
                        </form>
                    </div>
                    <div>
                        <div class="text-center middle-border relative">
                            <span
                                class="font-normal text-sm leading-8.5 tracking-small text-col-12 mx-auto inline-block">Or</span>
                        </div>
                        <div class="flex justify-center mt-4 lg:mt-6">
                            <button id="google-signin-btn" class="extra-login-btn w-full">
                                <span>
                                    <svg width="21" height="20" viewBox="0 0 21 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <g clip-path="url(#clip0_260_28785)">
                                            <path
                                                d="M20.305 10.2303C20.305 9.55056 20.2499 8.86711 20.1323 8.19836H10.7V12.0492H16.1015C15.8773 13.2911 15.1571 14.3898 14.1026 15.0879V17.5866H17.325C19.2174 15.8449 20.305 13.2728 20.305 10.2303Z"
                                                fill="#4285F4" />
                                            <path
                                                d="M10.7 20.0007C13.397 20.0007 15.6715 19.1152 17.3287 17.5866L14.1062 15.088C13.2096 15.6979 12.0522 16.0433 10.7037 16.0433C8.0948 16.0433 5.88279 14.2833 5.08911 11.9169H1.76373V14.4927C3.46133 17.8695 6.91898 20.0007 10.7 20.0007Z"
                                                fill="#34A853" />
                                            <path
                                                d="M5.08546 11.9169C4.66657 10.6749 4.66657 9.33008 5.08546 8.08811V5.51233H1.76376C0.345428 8.33798 0.345428 11.667 1.76376 14.4927L5.08546 11.9169Z"
                                                fill="#FBBC04" />
                                            <path
                                                d="M10.7 3.95805C12.1257 3.936 13.5036 4.47247 14.5361 5.45722L17.3911 2.60218C15.5833 0.904588 13.1839 -0.0287217 10.7 0.000673889C6.91898 0.000673889 3.46133 2.13185 1.76373 5.51234L5.08543 8.08813C5.87543 5.71811 8.09112 3.95805 10.7 3.95805Z"
                                                fill="#EA4335" />
                                        </g>
                                        <defs>
                                            <clipPath id="clip0_260_28785">
                                                <rect width="20" height="20" fill="white"
                                                    transform="translate(0.5)" />
                                            </clipPath>
                                        </defs>
                                    </svg>
                                </span>
                                <span>Sign in with Google</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <p
                            class="text-center font-roboto font-normal leading-[160%] tracking-small text-base text-col-7">
                            Don't you
                            have an account? <a href="signup.html" class="text-col-11">Sign up</a></p>
                    </div>
                </div>
                <div>
                    <p class=" font-normal text-xs lg:text-sm leading-full tracking-small text-center text-col-5">© 2025
                        ALL
                        RIGHTS
                        RESERVED</p>
                </div>
            </div>
            <div class="max-lg:hidden">
                <div class="swiper loginart">
                    <div class="swiper-wrapper">
                        <div class="swiper-slide">
                            <div class="loginart-image">
                                <img src="images/login-art-1.jpg" alt="login-art-1">
                            </div>
                            <div
                                class="loginart-text absolute bottom-16 xl:bottom-20 2xl:bottom-46 left-0 2xl:px-23 xl:px-13 z-2 px-8">
                                <h3>Borderless banking starts here.</h3>
                                <p>Receive, send and manage multiple currencies in one app. Open a foreign bank
                                    account
                                    for free.</p>
                            </div>
                        </div>
                        <div class="swiper-slide">
                            <div class="loginart-image">
                                <img src="images/login-art-2.jpg" alt="login-art-2">
                            </div>
                            <div
                                class="loginart-text absolute bottom-16 xl:bottom-20 2xl:bottom-46 left-0 2xl:px-23 xl:px-13 z-2 px-8">
                                <h3>From ‘just down the road’ to ‘halfway across the globe’.</h3>
                                <p>Send money to anyone, just about anywhere. Sendana-to-Sendana transfers are free!</p>
                            </div>
                        </div>
                        <div class="swiper-slide">
                            <div class="loginart-image">
                                <img src="images/login-art-1.jpg" alt="login-art-1">
                            </div>
                            <div
                                class="loginart-text absolute bottom-16 xl:bottom-20 2xl:bottom-46 left-0 2xl:px-23 xl:px-13 z-2 px-8">
                                <h3>Borderless banking starts here.</h3>
                                <p>Receive, send and manage multiple currencies in one app. Open a foreign bank
                                    account
                                    for free.</p>
                            </div>
                        </div>
                        <div class="swiper-slide">
                            <div class="loginart-image">
                                <img src="images/login-art-2.jpg" alt="login-art-2">
                            </div>
                            <div
                                class="loginart-text absolute bottom-16 xl:bottom-20 2xl:bottom-46 left-0 2xl:px-23 xl:px-13 z-2 px-8">
                                <h3>From ‘just down the road’ to ‘halfway across the globe’.</h3>
                                <p>Send money to anyone, just about anywhere. Sendana-to-Sendana transfers are free!</p>
                            </div>
                        </div>
                    </div>
                    <div class="swiper-button-next"></div>
                    <div class="swiper-button-prev"></div>
                    <div class="swiper-pagination !bottom-20 xl:!bottom-24 2xl:!bottom-46"></div>
                </div>
            </div>
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>
        // Initialize Swiper
        var swiper = new Swiper(".loginart", {
            slidesPerView: 1,
            spaceBetween: 30,
            loop: true,
            pagination: {
                el: ".swiper-pagination",
                clickable: true,
            },
            autoplay: {
                delay: 5000,
                disableOnInteraction: false,
            },
            navigation: {
                nextEl: ".swiper-button-next",
                prevEl: ".swiper-button-prev",
            },
        });

        // Privy configuration
        const PRIVY_APP_ID = 'cmhow02lw00b3l10cz7f0gbpu';
        const API_URL = 'http://localhost:3000';

        // Initialize Privy client
        let privyClient;
        let pendingEmail = null;

        // Check for OAuth callback
        const urlParams = new URLSearchParams(window.location.search);
        const oauthCode = urlParams.get('code');
        const oauthState = urlParams.get('state');

        if (window.PrivyCore && window.PrivyCore.PrivyClient) {
            privyClient = new window.PrivyCore.PrivyClient({
                appId: PRIVY_APP_ID,
            });

            // If we have OAuth params, handle the callback
            if (oauthCode && oauthState) {
                handleOAuthCallback();
            }
        } else {
            console.error('Privy SDK not loaded');
        }

        // Email Authentication - Step 1: Send code
        async function sendEmailCode(email) {
            try {
                if (!privyClient) throw new Error('Privy not initialized');

                await privyClient.auth.email.sendCode({ email });
                pendingEmail = email;
                console.log('Verification code sent to:', email);
                return true;
            } catch (error) {
                console.error('Failed to send email code:', error);
                throw error;
            }
        }

        // Email Authentication - Step 2: Verify code and login
        async function loginWithEmailCode(code) {
            try {
                if (!privyClient || !pendingEmail) throw new Error('No pending email auth');

                const authResult = await privyClient.auth.email.loginWithCode({
                    email: pendingEmail,
                    code: code,
                });

                // Authenticate with backend
                await authenticateWithBackend(authResult.token, {
                    email: pendingEmail,
                    provider: 'email'
                });

                pendingEmail = null;
            } catch (error) {
                console.error('Email verification failed:', error);
                alert('Invalid verification code. Please try again.');
                throw error;
            }
        }

        // Google OAuth Authentication
        async function loginWithGoogle() {
            try {
                if (!privyClient) throw new Error('Privy not initialized');

                const result = await privyClient.auth.oauth.generateURL({
                    provider: 'google',
                });

                // Store state for verification
                localStorage.setItem('privy_oauth_state', result.state);
                localStorage.setItem('privy_oauth_provider', 'google');

                // Redirect to Google OAuth
                window.location.href = result.url;
            } catch (error) {
                console.error('Google OAuth failed:', error);
                alert('Failed to initiate Google sign-in. Please try again.');
            }
        }

        // Handle OAuth callback
        async function handleOAuthCallback() {
            try {
                const storedState = localStorage.getItem('privy_oauth_state');
                const provider = localStorage.getItem('privy_oauth_provider');

                if (oauthState !== storedState) {
                    throw new Error('Invalid OAuth state');
                }

                const authResult = await privyClient.auth.oauth.loginWithCode({
                    code: oauthCode,
                    state: oauthState,
                });

                // Authenticate with backend
                await authenticateWithBackend(authResult.token, {
                    provider: provider
                });

                // Clean up
                localStorage.removeItem('privy_oauth_state');
                localStorage.removeItem('privy_oauth_provider');
            } catch (error) {
                console.error('OAuth callback error:', error);
                alert('Authentication failed. Please try again.');
                window.location.href = '/index.html';
            }
        }

        // Authenticate with backend
        async function authenticateWithBackend(privyToken, additionalData) {
            try {
                const response = await fetch(`${API_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${privyToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(additionalData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Authentication failed');
                }

                const data = await response.json();

                // Save session
                localStorage.setItem('sendana_user', JSON.stringify(data.user));
                localStorage.setItem('sendana_token', privyToken);

                // Redirect to dashboard
                window.location.href = '/dashboard.html';
            } catch (error) {
                console.error('Backend authentication error:', error);
                throw error;
            }
        }

        // Handle email form submission
        document.querySelector('form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const emailInput = document.getElementById('email');
            const email = emailInput.value.trim();

            if (!email) {
                alert('Please enter your email address');
                return;
            }

            // Validate email format
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                alert('Please enter a valid email address');
                return;
            }

            try {
                // Send verification code
                await sendEmailCode(email);

                // Ask for verification code
                const code = prompt('A verification code has been sent to your email. Please enter it below:');

                if (!code) {
                    alert('Verification cancelled');
                    return;
                }

                // Verify code and login
                await loginWithEmailCode(code);
            } catch (error) {
                console.error('Email authentication error:', error);
            }
        });

        // Handle Google sign in button
        const googleBtn = document.getElementById('google-signin-btn');
        if (googleBtn) {
            googleBtn.addEventListener('click', function(e) {
                e.preventDefault();
                loginWithGoogle();
            });
        }
    </script>
</body>

</html>